<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Grafik.Converters"
             x:Class="Grafik.ChatPage"
             Title="Ð§Ð°Ñ‚">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:Base64ToImageSourceConverter x:Key="Base64ToImage"/>
            <local:TextToFormattedStringConverter x:Key="TextToLinks"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto,Auto" Padding="0">
        <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»Ñ‘Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
        <Frame x:Name="PinnedMessagesFrame"
               Padding="0"
               Margin="0"
               CornerRadius="0"
               HasShadow="True"
               BackgroundColor="#FFF3E0"
               IsVisible="False"
               Grid.Row="0">
            <CollectionView x:Name="PinnedMessagesCollectionView"
                           SelectionMode="Single"
                           ItemsUpdatingScrollMode="KeepScrollOffset"
                           HeightRequest="100">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeThickness="2" 
                                Stroke="#FF9800" 
                                Padding="10"
                                BackgroundColor="White"
                                StrokeShape="RoundRectangle 8,8,8,8"
                                Margin="5">
                            <StackLayout Spacing="5" WidthRequest="150">
                                <Label Text="ðŸ“Œ Ð—Ð°ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¾"
                                      FontSize="10"
                                      TextColor="#FF6F00"
                                      FontAttributes="Bold"/>
                                <Label Text="{Binding FileName, StringFormat='ðŸ“Ž {0}'}"
                                      FontAttributes="Bold"
                                      TextColor="#2E7D32"
                                      FontSize="11"
                                      LineBreakMode="TailTruncation"/>
                                <Label Text="{Binding FileSizeDisplay}"
                                      FontSize="9"
                                      TextColor="Gray"/>
                                <Button Text="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ"
                                       Clicked="OnPinnedMessageClicked"
                                       CommandParameter="{Binding .}"
                                       BackgroundColor="#FF9800"
                                       TextColor="White"
                                       Padding="5"
                                       FontSize="11"
                                       CornerRadius="4"/>
                            </StackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Frame>

        <!-- Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
        <CollectionView x:Name="MessagesCollectionView"
                       Grid.Row="1"
                       SelectionMode="Single"
                       VerticalScrollBarVisibility="Always">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <StackLayout Padding="10,5" Spacing="5">
                        <!-- Ð˜Ð¼Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ + Ð²Ñ€ÐµÐ¼Ñ -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Label Grid.Column="0"
                                  Text="{Binding Sender}"
                                  FontAttributes="Bold"
                                  FontSize="13"
                                  TextColor="#007ACC"/>
                            <Label Grid.Column="1"
                                  Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                  FontSize="11"
                                  TextColor="Gray"/>
                        </Grid>

                        <!-- Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Ð´Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð¸ ÐºÐ°Ðº Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ Ð´Ð»Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹) -->
                        <Label FormattedText="{Binding Text, Converter={StaticResource TextToLinks}}"
                              LineBreakMode="WordWrap"
                              FontSize="14"
                              Padding="0,0,0,5"
                              IsVisible="{Binding IsText}"/>

                        <!-- Ð‘Ð»Ð¾Ðº Ð´Ð»Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ -->
                        <Frame Padding="5"
                               BackgroundColor="#F5F5F5"
                               HasShadow="True"
                               CornerRadius="8"
                               IsVisible="{Binding IsImage}"
                               Margin="0">
                            <StackLayout Spacing="5">
                                <Image Source="{Binding ImageData, Converter={StaticResource Base64ToImage}}"
                                      MaximumHeightRequest="300"
                                      MaximumWidthRequest="300"
                                      Aspect="AspectFit"
                                      HorizontalOptions="Start"/>
                                <Label Text="{Binding FileSizeDisplay}"
                                      FontSize="10"
                                      TextColor="Gray"/>
                            </StackLayout>
                        </Frame>

                        <!-- Ð‘Ð»Ð¾Ðº Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² -->
                        <Frame Padding="10" 
                               BackgroundColor="{Binding IsMessagePinned, Converter={local:PinnedBackgroundConverter}}"
                               HasShadow="True" 
                               CornerRadius="8"
                               IsVisible="{Binding IsFile}"
                               Margin="0">
                            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                                <StackLayout Grid.Column="0" Spacing="3">
                                    <Label Text="{Binding FileName, StringFormat='ðŸ“Ž {0}'}"
                                          FontAttributes="Bold"
                                          TextColor="#2E7D32"
                                          FontSize="12"/>
                                    <Label Text="{Binding FileSizeDisplay}"
                                          FontSize="10"
                                          TextColor="Gray"/>
                                </StackLayout>

                                <Button Grid.Column="1"
                                       Text="{Binding PinButtonText}"
                                       Clicked="OnPinFileClicked"
                                       CommandParameter="{Binding .}"
                                       BackgroundColor="{Binding IsMessagePinned, Converter={local:PinButtonColorConverter}}"
                                       TextColor="White"
                                       Padding="12,8"
                                       FontSize="11"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"/>

                                <Button Grid.Column="2"
                                       Text="â¬‡ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"
                                       Clicked="OnDownloadFileClicked"
                                       CommandParameter="{Binding .}"
                                       BackgroundColor="#4CAF50"
                                       TextColor="White"
                                       Padding="15,10"
                                       FontSize="13"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"
                                       CornerRadius="6"/>
                            </Grid>
                        </Frame>
                        <!-- Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ -->
                        <BoxView Color="#CCCCCC" HeightRequest="1" Margin="0,5"/>
                    </StackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑÐ¼Ð¾Ð´Ð·Ð¸ (ÑÐºÑ€Ñ‹Ñ‚Ð° Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ) -->
        <Frame x:Name="EmojiPanel"
               Grid.Row="2"
               IsVisible="False"
               Padding="8"
               Margin="0"
               CornerRadius="0"
               HasShadow="True"
               BackgroundColor="#FAFAFA"
               HeightRequest="160">
            <ScrollView>
                <Grid x:Name="EmojiGrid" ColumnSpacing="2" RowSpacing="2"/>
            </ScrollView>
        </Frame>

        <!-- Ð’Ð²Ð¾Ð´ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
        <Grid Grid.Row="3"
             ColumnDefinitions="Auto,Auto,*,Auto,Auto"
             ColumnSpacing="6"
             Padding="8"
             RowSpacing="0"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}">

            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐ¼Ð¾Ð´Ð·Ð¸ -->
            <Button x:Name="EmojiToggleButton"
                   Grid.Column="0"
                   Text="ðŸ˜€"
                   Clicked="OnEmojiToggleClicked"
                   BackgroundColor="Transparent"
                   FontSize="22"
                   Padding="4"
                   WidthRequest="44"
                   HeightRequest="44"/>

            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ -->
            <Button x:Name="ImageButton"
                   Grid.Column="1"
                   Text="ðŸ–¼ï¸"
                   Clicked="OnImageClicked"
                   BackgroundColor="Transparent"
                   FontSize="22"
                   Padding="4"
                   WidthRequest="44"
                   HeightRequest="44"/>

            <Border Grid.Column="2"
                   Stroke="#CCCCCC"
                   StrokeThickness="1"
                   Padding="0">
                <Entry x:Name="MessageEntry"
                      Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                      PlaceholderColor="#999999"
                      TextColor="#000000"
                      BackgroundColor="#FFFFFF"
                      FontSize="14"
                      Margin="0"/>
            </Border>

            <Button x:Name="ShareButton"
                   Grid.Column="3"
                   Text="ðŸ“Ž"
                   Clicked="OnShareFileClicked"
                   BackgroundColor="#FF9800"
                   TextColor="White"
                   FontSize="18"
                   Padding="0"
                   WidthRequest="50"/>

            <Button x:Name="SendButton"
                   Grid.Column="4"
                   Text="âž¤"
                   Clicked="OnSendClicked"
                   BackgroundColor="#007ACC"
                   TextColor="White"
                   FontSize="18"
                   Padding="0"
                   WidthRequest="50"/>
        </Grid>
    </Grid>
</ContentPage>